name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release-mac:
    runs-on: macos-14
    permissions:
      contents: write
    
    steps:
      - name: Checkout kshana-desktop
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Prepare release/app
        run: |
          mkdir -p release/app
          node << 'EOF'
          const fs = require('fs');
          const mainPkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          const appPkg = {
            name: mainPkg.name,
            version: mainPkg.version || '1.0.0',
            description: mainPkg.description,
            main: './dist/main/main.js',
            dependencies: {}
          };
          if (mainPkg.dependencies) {
            Object.keys(mainPkg.dependencies).forEach(dep => {
              appPkg.dependencies[dep] = mainPkg.dependencies[dep];
            });
          }
          fs.writeFileSync('release/app/package.json', JSON.stringify(appPkg, null, 2) + '\n');
          console.log('Created release/app/package.json');
          EOF

      - name: Install dependencies
        run: |
          npm ci --ignore-scripts
          npx ts-node .erb/scripts/check-native-dep.js
          npm run build:dll

      - name: Inject server config
        run: |
          node << 'EOF'
          const fs = require('fs');
          const url = process.env.KSHANA_SERVER_URL;
          if (!url) throw new Error('KSHANA_SERVER_URL is missing');
          fs.writeFileSync('assets/runtime-config.json', JSON.stringify({ serverUrl: url }, null, 2));
          console.log('Wrote assets/runtime-config.json');
          EOF
        env:
          KSHANA_SERVER_URL: ${{ secrets.KSHANA_SERVER_URL }}

      - name: Build and Publish Electron app
        run: npm run release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    env:
      NODE_OPTIONS: --max-old-space-size=4096
    
    steps:
      - name: Checkout kshana-desktop
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Prepare release/app
        run: |
          New-Item -ItemType Directory -Force -Path release/app
          $script = @'
          const fs = require('fs');
          const mainPkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          const appPkg = {
            name: mainPkg.name,
            version: mainPkg.version || '1.0.0',
            description: mainPkg.description,
            main: './dist/main/main.js',
            dependencies: {}
          };
          if (mainPkg.dependencies) {
            Object.keys(mainPkg.dependencies).forEach(dep => {
              appPkg.dependencies[dep] = mainPkg.dependencies[dep];
            });
          }
          fs.writeFileSync('release/app/package.json', JSON.stringify(appPkg, null, 2) + '\n');
          console.log('Created release/app/package.json');
          '@
          node -e $script

      - name: Install dependencies
        run: |
          $env:NODE_OPTIONS="--max-old-space-size=4096"
          npm ci --ignore-scripts
          npx ts-node .erb/scripts/check-native-dep.js
          npm run build:dll

      - name: Inject server config
        run: |
          $url = "${{ secrets.KSHANA_SERVER_URL }}"
          if (-not $url) { throw "KSHANA_SERVER_URL is missing" }
          $json = @{ serverUrl = $url } | ConvertTo-Json
          Set-Content -Path "assets/runtime-config.json" -Value $json -Encoding UTF8
          Write-Host "Wrote assets/runtime-config.json"

      - name: Build and Publish Electron app
        run: npm run release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
